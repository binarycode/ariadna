# Unit Testing Capability

## Purpose

Defines the unit testing approach for firmware services, including mock integration with shaku DI and service call verification patterns.

## ADDED Requirements

### Requirement: Mockall integration with shaku

Mock types generated by `mockall::mock!` SHALL implement `shaku::Component<M>` to enable use in test modules.

#### Scenario: Mock service in test module

- **WHEN** a mock is defined with `mockall::mock!` for a service interface
- **THEN** the mock type SHALL have a manual `impl<M: shaku::Module> shaku::Component<M>` implementation
- **AND** the mock can be used in a shaku `module!` definition

### Requirement: TestModule pattern with component override

Tests requiring DI SHALL define test-specific shaku modules and inject configured mocks via `with_component_override`.

#### Scenario: Test module with mocks

- **WHEN** testing a service that depends on other services
- **THEN** the test SHALL define a TestModule declaring only the service under test
- **AND** configure mock expectations before module construction
- **AND** inject mocks using `with_component_override::<dyn Interface>(Box::new(mock))`
- **AND** resolve the service under test from that module

### Requirement: Service call order verification

Tests for orchestration services SHALL verify that dependent services are called in the correct order.

#### Scenario: MainService call ordering

- **WHEN** MainService.run() is executed
- **THEN** Esp32Service.init() SHALL be called first
- **AND** EventLoopService.run() SHALL be called second
- **AND** Esp32Service.halt() SHALL be called last

### Requirement: Smoke tests for simple services

Services with no complex logic SHALL have smoke tests that verify methods don't panic on host.

#### Scenario: Esp32Service smoke test

- **WHEN** Esp32Service.init() is called on host architecture
- **THEN** the method completes without panic

#### Scenario: Esp32Service halt smoke test

- **WHEN** Esp32Service.halt() is called on host architecture
- **THEN** the method completes without panic

### Requirement: MainService extraction

The main function orchestration logic SHALL be extracted into a MainService component that can be tested via DI.

#### Scenario: MainService replaces main logic

- **WHEN** main() runs
- **THEN** it SHALL resolve MainService from AppModule
- **AND** call MainService.run() to execute the application

#### Scenario: MainService owns channel creation

- **WHEN** MainService.run() is called
- **THEN** it SHALL create the channel internally (Sender/Receiver pair)
- **AND** pass the Receiver to EventLoopService.run()
- **AND** return the Sender for external use
